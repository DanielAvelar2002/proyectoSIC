{% extends "base.html" %}

{% block titulo %} Hoja de Trabajo {% endblock %}

{% block contenido %}

<!--Hoja de trabajo-->
<div class="card">
    <h5 class="card-header">Hoja de Trabajo</h5>
    <div class="card-body">
        <p class="fw-bolder text-center">Total General Debe: {{ total_general_debe }}</p>
        <p class="fw-bolder text-center">Total General Haber: {{ total_general_haber }}</p> 
        <div class="card-group">
            <!--Balance de comprobacion-->
            <div class="card">
                <br>
                <h5 class="card-title text-center">Balance de Comprobación</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tr>    
                            <th>Cuenta</th>                        
                            <th>Debe</th>
                            <th>Haber</th>
                        </tr>
                        {% for cuenta in balance %}
                        <tr>
                            <td>{{ cuenta.nombre_cuenta }}</td>
                            {% if cuenta.saldo_debe > 0 %}
                                <td>{{ cuenta.total_debe }}</td>
                                <td></td>
                            {% else %}
                                <td></td>
                                <td>{{ cuenta.total_haber }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            <!--Ajustes
            <div class="card">
                <br><h5 class="card-title text-center">Ajustes</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tr>
                            <th>Debe</th>
                            <th>Haber</th>
                        </tr>
                        {% for cuenta in balance %}
                        <tr>
                            <td readonly>{{ cuenta.nombre_cuenta }}</td>
                            <td readonly>{{ cuenta.saldo_debe|default:'' }}</td>
                            <td readonly>{{ cuenta.saldo_haber|default:'' }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                
                </div>
            </div>-->
            <!--Balance de Comprobacion Ajustado-->
            <div class="card">
            <br>
                <h5 class="card-title text-center">Balance de Comprobació Ajustado</h5>
                <div class="table-responsive">
                    
                    <table class="table table-bordered">
                        <tr>
                            <th>Cuenta</th>
                            <th>Debe</th>
                            <th>Haber</th>
                        </tr>
                        {% for cuenta in balance %}
                        <tr>
                            <td readonly>{{ cuenta.nombre_cuenta }}</td>
                            <td readonly>{{ cuenta.saldo_debe|default:'' }}</td>
                            <td readonly>{{ cuenta.saldo_haber|default:'' }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>                       
            </div>
        </div>
        <br>
        <!--Columna 2-->
        <div class="card-group">
            <!--Estado de Resultado-->
            <div class="card">
                <br>
                <h5 class="card-title text-center">Estado de Resultado</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tr>                            
                            <th>Debe</th>
                            <th>Haber</th>
                        </tr>
                        {% for cuenta in balance %}
                        <tr>
                            <td>{{ cuenta.total_debe }}</td>
                            <td>{{ cuenta.total_haber }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            <!--Estado de Capital-->
            <div class="card">
                <br>
                <h5 class="card-title text-center">Estado de Capital</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tr>                            
                            <th>Debe</th>
                            <th>Haber</th>
                        </tr>
                        {% for cuenta in balance %}
                        <tr>
                            <td>{{ cuenta.total_debe }}</td>
                            <td>{{ cuenta.total_haber }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            <!--Balance General-->
            <div class="card">
                <br>
                <h5 class="card-title text-center">Balance General</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tr>                            
                            <th>Debe</th>
                            <th>Haber</th>
                        </tr>
                        {% for cuenta in balance %}
                        <tr>
                            <td>{{ cuenta.total_debe }}</td>
                            <td>{{ cuenta.total_haber }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>          
        </div>
    </div>
<br>


<form method="post" action="{% url 'hojaTrabajo' %}" onsubmit="return validarMonto()">
  {% csrf_token %}
  <div class="card">
      <h5 class="card-header">Registro de Ajustes</h5>
      <div class="card-body">
          <div class="row">
              <div class="col-sm-6">
                  <div class="card">
                      <div class="card-body">
                          <label for="fecha">Fecha:</label>
                          <div class="form-group">
                              <input type="date" name="fecha"  class="form-control" required ><br>
                          </div>
                          <br>

                          <label for="concepto">Concepto:</label>
                          <div class="input-group">
                              <textarea name="concepto" class="form-control" required></textarea>
                          </div>
                          <br>

                          <label for="monto">Monto:</label>
                          <div class="input-group mb-3">
                              <span class="input-group-text">$</span>
                              <input type="number" step="0.01" name="monto" required>
                              <span class="input-group-text">.00</span>
                          </div>                           
                          <br>

                          <label for="iva">Tipo de IVA:</label>
                          <select name="iva" class="form-select" id="autoSizingSelect" required>
                              <option value="Ninguno" selected>Ninguno...</option>
                              <option value="CreditoFiscal">IVA Crédito Fiscal</option>
                              <option value="DebitoFiscal">IVA Débito Fiscal</option>
                          </select>
                          <br>                                               
                      </div>
                  </div>
              </div>                                               

              <div class="col-sm-6">
                  <div class="card border-danger mb-3">
                      <div class="card-header text-danger fw-bold">Cargo</div>
                      <div class="card-body">

                          <select name="cargo_cuenta" class="form-select cuenta-select"  data-clase-id="" required>
                              <option value="" selected disabled>Selecciona una cuenta</option>
                              {% for cuenta in cuentas %}
                                  <option value="{{ cuenta.id }}" data-clase-id="{{ cuenta.clase_id }}"> {{ cuenta.nombre }} ({{ cuenta.clase }}) </option>
                              {% endfor %}
                          </select><br>
                      </div>  
                  </div>

                  <div class="card border-primary mb-3">
                      <div class="card-header text-primary fw-bold">Abono</div>
                      <div class="card-body">
  

                          <select name="abono_cuenta" class="form-select" required>
                              <option value="" selected disabled>Selecciona una cuenta</option>
                              {% for cuenta in cuentas %}
                                  <option value="{{ cuenta.id }}">{{ cuenta.nombre }} ({{ cuenta.clase }})</option>
                              {% endfor %}
                          </select><br>
                      </div>                    
                  </div>

                  <button onclick="aplicarAjustes()">Aplicar Ajustes</button>
                  <input type="button" class="btn btn-warning" value="Limpiar Campos" id="limpiarCampos">        
              </div>                    
          </div>                              
      </div>    
  </div>
</form> <!--FIn del Formulario-->    


<script>

// Variables globales
var balanceAjustado = null;

// Función para cargar el Balance de Comprobación Ajustado
function cargarBalanceAjustado() {
    // Obtener el Balance de Comprobación Ajustado del servidor
    $.ajax({
        url: '/transacciones/obtener_balance_ajustado',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            // Guardar el Balance de Comprobación Ajustado en una variable global
            balanceAjustado = data;

            // Actualizar la tabla con los datos del Balance de Comprobación Ajustado
            updateTable();
        }
    });
}

// Función para actualizar la tabla
function updateTable() {
    // Obtener las filas de la tabla
    var rows = document.querySelectorAll('table tbody tr');

    // Recorrer las filas de la tabla
    for (var i = 0; i < rows.length; i++) {
        // Obtener la cuenta de la fila actual
        var cuenta = rows[i].querySelector('td:nth-child(1)').textContent;

        // Obtener el saldo de la cuenta
        var saldo = balanceAjustado.saldo[cuenta];

        // Actualizar la celda del saldo
        rows[i].querySelector('td:nth-child(2)').textContent = saldo;
        rows[i].querySelector('td:nth-child(3)').textContent = saldo;
    }
}

// Inicializar la función
cargarBalanceAjustado();

</script>

















<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>



//Boton de limpiar campos
$(document).ready(function() {
  // Escucha el clic en el botón "Limpiar"
  $("#limpiarCampos").on("click", function() {
      // Limpia todos los campos del formulario
      $("form input[type='text'], form input[type='number'], form input[type='date'], form textarea, form select").val("");
  });
});

//validacion de negativos
function validarMonto() {
  var monto = parseFloat(document.getElementsByName("monto")[0].value);

  if (isNaN(monto) || monto <= 0) {
      alert("El monto debe ser un número mayor que cero.");
      return false;
  }

  return true;
}
</script>
 
{% endblock %}